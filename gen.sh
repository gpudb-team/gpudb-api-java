#!/usr/bin/env bash

# The directory of this script
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

pushd $SCRIPT_DIR > /dev/null

SCHEMA_DIR="$(cd $SCRIPT_DIR/../../gaiadb-schemas/obj_defs/ && pwd)"

echo "Copying and compiling ${SCHEMA_DIR}/*.json to $PWD"
mkdir -p src/avro/schema

# ---------------------------------------------------------------------------
# Create a javascript map of the endpoints to the schemas

ENDPOINT_LIST="$(cat $SCHEMA_DIR/endpoints.txt | grep -vE '^#')"
GADMIN_JSON_JS_FILE=$SCRIPT_DIR/../gpudb-admin/src/main/webapp/js/endpoints.js
echo "// This file is autogenerated, do not edit." > $GADMIN_JSON_JS_FILE
echo >> $GADMIN_JSON_JS_FILE
echo "var GPUdb_request_schema_map = {}" >> $GADMIN_JSON_JS_FILE
echo "var GPUdb_response_schema_map = {}" >> $GADMIN_JSON_JS_FILE
echo >> $GADMIN_JSON_JS_FILE

# ---------------------------------------------------------------------------

find "${SCHEMA_DIR}" -name "*.json" | sort | while read -r file; do
    #echo "${file}"
    #cp "${file}" ./temp/
    filename=$(basename ${file})
    schema_name="${filename%.*}"

    # Add in "namespace" : "avro.java.gpudb",
    sed 's/^{/{\n    "namespace" : "avro.java.gpudb",/g' "${file}" > ./src/avro/schema/$filename

    # -----------------------------------------------------------------------
    # Add to the gadmin javascript map file of the schemas, if it's known.
    ENDPOINT_INFO=$(echo -e "$ENDPOINT_LIST" | grep $schema_name)
    if [[ "a$ENDPOINT_INFO" != "a" ]]; then
        ENDPOINT_NAME=$(echo $ENDPOINT_INFO | awk '{ print $1 }')
        JSON=$(cat $file)
        if [[ $file == *"request"* ]]; then
            echo "GPUdb_request_schema_map[\"$ENDPOINT_NAME\"] = ${JSON};" >> $GADMIN_JSON_JS_FILE
        else
            echo "GPUdb_response_schema_map[\"$ENDPOINT_NAME\"] = ${JSON};" >> $GADMIN_JSON_JS_FILE
        fi
        echo >> $GADMIN_JSON_JS_FILE
    fi
done

# ---------------------------------------------------------------------------

# Make an array of the endpoints
echo "// Create an array of the endpoint names." >> $GADMIN_JSON_JS_FILE
echo "var GPUdb_endpoints = []" >> $GADMIN_JSON_JS_FILE
echo "for (var name in GPUdb_request_schema_map) { GPUdb_endpoints.push(name); }" >> $GADMIN_JSON_JS_FILE
echo "GPUdb_endpoints.sort();" >> $GADMIN_JSON_JS_FILE

# ---------------------------------------------------------------------------

java -cp "../gpudb-api/lib/avro-tools-1.7.7.jar;." org.apache.avro.tool.Main compile schema src/avro/schema/* src/
